<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Begin Jekyll SEO tag v2.4.0 -->
<title>AWS: EBS Snapshot Scheduling | Hazaq</title>
<meta name="generator" content="Jekyll v3.7.2" />
<meta property="og:title" content="AWS: EBS Snapshot Scheduling" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Overview In Amazon RDS you can schedule snapshot creation and deletion were snapshots are automatically created and delete after the retention period and you can do all this with in the RDS management console while or after creating the RDS. To do this with Amazon EBS volumes for EC2 there are couple of things you need to do, first schedule automated EBS snapshots using CloudWatch Event rule and then delete old snapshots using AWS Lambda function." />
<meta property="og:description" content="Overview In Amazon RDS you can schedule snapshot creation and deletion were snapshots are automatically created and delete after the retention period and you can do all this with in the RDS management console while or after creating the RDS. To do this with Amazon EBS volumes for EC2 there are couple of things you need to do, first schedule automated EBS snapshots using CloudWatch Event rule and then delete old snapshots using AWS Lambda function." />
<link rel="canonical" href="http://localhost:4000/aws/2018/02/15/AWS-EBS-Snapshot-Scheduling.html" />
<meta property="og:url" content="http://localhost:4000/aws/2018/02/15/AWS-EBS-Snapshot-Scheduling.html" />
<meta property="og:site_name" content="Hazaq" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-02-15T12:56:00+04:00" />
<script type="application/ld+json">
{"datePublished":"2018-02-15T12:56:00+04:00","dateModified":"2018-02-15T12:56:00+04:00","headline":"AWS: EBS Snapshot Scheduling","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/aws/2018/02/15/AWS-EBS-Snapshot-Scheduling.html"},"url":"http://localhost:4000/aws/2018/02/15/AWS-EBS-Snapshot-Scheduling.html","description":"Overview In Amazon RDS you can schedule snapshot creation and deletion were snapshots are automatically created and delete after the retention period and you can do all this with in the RDS management console while or after creating the RDS. To do this with Amazon EBS volumes for EC2 there are couple of things you need to do, first schedule automated EBS snapshots using CloudWatch Event rule and then delete old snapshots using AWS Lambda function.","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  <link rel="stylesheet" href="/assets/main.css">
  <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Hazaq" />
  
</head>


  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">
    
    
    <a class="site-title" rel="author" href="/">Hazaq</a>

    
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
          
            
            
          
            
            
            <a class="page-link" href="/about/">About</a>
            
          
            
            
            <a class="page-link" href="/CheatSheet">Cheat Sheet</a>
            
          
            
            
          
            
            
          
            
            
          
        </div>
      </nav>
    
  </div>
</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">AWS: EBS Snapshot Scheduling</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2018-02-15T12:56:00+04:00" itemprop="datePublished">
        
        Feb 15, 2018
      </time>
      </p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p><strong>Overview</strong><br />
In Amazon RDS you can schedule snapshot creation and deletion were snapshots are automatically created and delete after the retention period and you can do all this with in the RDS management console while or after creating the RDS. To do this with Amazon EBS volumes for EC2 there are couple of things you need to do, first schedule automated EBS snapshots using CloudWatch Event rule and then delete old snapshots using AWS Lambda function.</p>

<p><strong>Schedule Automated Amazon EBS Snapshots Using CloudWatch Events</strong><br />
You can follow <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/events/TakeScheduledSnapshot.html">these</a> instructions<br />
Create a Rule<br />
 <strong>1)</strong> Open the CloudWatch<br />
 <strong>2)</strong> In the navigation pane, choose Events, Create rule<br />
 <strong>3)</strong> For Event Source: Choose Schedule. Choose Fixed rate of and specify the schedule interval.<br />
 <strong>4)</strong> For Targets, choose Add target and then select EC2 Create Snapshot API call.<br />
 <strong>5)</strong> For Volume ID, choose an EBS volume.<br />
 <strong>6)</strong> Choose Configure details.<br />
 <strong>7)</strong> For Rule definition, type a name and description for the rule.<br />
 <strong>8)</strong> For AWS permissions, choose the option to create a new role and create. This opens the IAM console in a new tab. The new role grants the built-in target permissions to access resources on your behalf. Choose Allow. The tab with the IAM window closes.<br />
 <strong>9)</strong> Choose Create rule.</p>

<p><strong>AWS Lambda function to delete old Snapshots</strong><br />
Now lets setup something to delete old snapshots else the snapshots will keep on piling up and it is impractical to delete them everyday manually. You can use lambda function to delete old snapshots.<br />
Lets first create the IAM permission required by the Lambda function. In the below template we are giving the CloudWatch log permissions so we can log the output of the lambda function as we purge the snapshots.</p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
    <span class="s2">"Version"</span><span class="p">:</span> <span class="s2">"2012-10-17"</span><span class="p">,</span>
    <span class="s2">"Statement"</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">"Effect"</span><span class="p">:</span> <span class="s2">"Allow"</span><span class="p">,</span>
            <span class="s2">"Action"</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">"logs:*"</span>
            <span class="p">],</span>
            <span class="s2">"Resource"</span><span class="p">:</span> <span class="s2">"arn:aws:logs:*:*:*"</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">"Effect"</span><span class="p">:</span> <span class="s2">"Allow"</span><span class="p">,</span>
            <span class="s2">"Action"</span><span class="p">:</span> <span class="s2">"ec2:Describe*"</span><span class="p">,</span>
            <span class="s2">"Resource"</span><span class="p">:</span> <span class="s2">"*"</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">"Effect"</span><span class="p">:</span> <span class="s2">"Allow"</span><span class="p">,</span>
            <span class="s2">"Action"</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">"ec2:CreateSnapshot"</span><span class="p">,</span>
                <span class="s2">"ec2:DeleteSnapshot"</span><span class="p">,</span>
                <span class="s2">"ec2:CreateTags"</span><span class="p">,</span>
                <span class="s2">"ec2:ModifySnapshotAttribute"</span><span class="p">,</span>
                <span class="s2">"ec2:ResetSnapshotAttribute"</span>
            <span class="p">],</span>
            <span class="s2">"Resource"</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">"*"</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now we can create the lambda function. <br />
<strong>1)</strong> Go to the lambda function page and click on <strong>Create a function</strong><br />
<strong>2)</strong> Select <strong>Author from scratch</strong> 
<img src="/assets/images/lambdaimage1.png" alt="Lambda image 1" /><br />
<strong>3)</strong> Enter a Name like PurgeOldSnaphosts<br />
<strong>4)</strong> under Runtime select python 2.x<br />
<strong>5)</strong> For Roles select <strong>Choose an exsisting role</strong>, select the rule that you created previously and create function.<br />
<strong>6)</strong> Now under the Configuration page scroll down to <strong>Function Code</strong> and copy <a href="https://github.com/hazaq/purgeOldSnapshots/blob/master/purge_snapshots.py">this</a> code.<br />
Don’t forget to change the following variables in the function, according to your environment.</p>
<ul>
  <li>snap_vol = ‘vol-12345678asdfg’ # The volume ID that needs to purged</li>
  <li>snap_exclude = [ ‘snap-09876wxyz’ ] # Any old snapshot you want to exclude from getting purged</li>
  <li>region = ‘us-west-2’ # Region where the purge should occure</li>
  <li>owner_ids = [ ‘111111111111’ ] # Owner id of the snapshot creater</li>
  <li>days = 31 # Retention period of old snapshots</li>
</ul>

<p>Finally we need to create a CloudWatch Event rule to trigger the function just like we did for creating the snapshots. So follow the same steps in <strong>Schedule Automated Amazon EBS Snapshots Using CloudWatch Events</strong> with the exception of step 4 where you need to choose a Lambda function as a Target.<br />
Our lambda function should look like this now.<br />
<img src="/assets/images/lambdaimg2.png" alt="lambdaimage2" /></p>

  </div>

  

  <a class="u-url" href="/aws/2018/02/15/AWS-EBS-Snapshot-Scheduling.html" hidden></a>
</article>

      </div>
    </main>

    <footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Hazaq</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">
            
              Hazaq
            
            </li>
            
            <li><a class="u-email" href="mailto:hazaq.naeem@gmail.com">hazaq.naeem@gmail.com</a></li>
            
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
  
  
  
  <li><a href="https://github.com/hazaq"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">hazaq</span></a></li>
  
  <li><a href="https://www.linkedin.com/in/hazaq-me"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg> <span class="username">hazaq-me</span></a></li>
  
  
  
  
  
</ul>

      </div>

      <div class="footer-col footer-col-3">
        <p>All things Linux | OpenSource Software | Redhat | AWS | DevOps | Zimbra</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
